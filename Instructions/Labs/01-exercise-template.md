
lab:“使用 Microsoft 365 智能体 SDK 创建自定义引擎智能体”
---
<!--
Edit the metadata above to manage the list of exercises in the home page of the GitHub site that gets generated.
You can delete the module and edit index.md in the root of the repo to customize the display so that only the exercises are listed
To enable GitHub page publishing, edit the Page settings for the repo and publish from the main branch
-->

# 创建和测试自定义代理

在本练习中，你将创建一个 Azure OpenAI 资源，该资源将用作创建自定义代理的基础。

完成此练习大约需要 60 分钟。 <!-- update with estimated duration -->

**备注：** 学习者可以使用以下选项完成此实验室
1) 为学员提供的实验室环境。
2) 学习者应在自己的环境中针对所有其他 ALH 完成此实验室。

##  任务 1：创建 Azure OpenAI 资源 

首先，你需要……

1. 在 Edge 浏览器中，导航到**https://portal.azure.com**。
1. 登录到 Azure 门户。
2. 在屏幕的左上方，单击“**+ 创建资源**”。
1. 在搜索框中，键入**azure openai**，并按 Enter。
1. 名为**Azure OpenAI** 的结果应显示为一个选项。 此选项的左下角是标记为“**创建**”的按钮。 按“**创建** >**Aure OpenAI**”。
1. 在“**创建 Azure OpenAI**”页下设置以下字段：

**备注：** 对于使用自己环境的学习者，在选择“**订阅**” 、“**定价层**”和“**资源组**”字段的值时，需自行决定。 对于使用提供的实验室环境的学员，请选择以下步骤 a-d 中字段的默认值。
   
   a. **订阅** 填写此字段时请自行决断。
   
   b. **资源组**：填写此字段时，请自行决断。
   
   c. **名称**：键入你选择的任何名称。
   
   d. **定价层**：默认值为“**标准版 S0**”，但在填写此字段时，请自行决断。
   
选择**下一步**。

7. 在下一页的“**网络**”选项卡中，选择“**所有网络（包括 Internet）均可访问此资源**”选项。
选择**下一步**。
8. 在下一页的“**标记**”选项卡中，将“名称”和“值”字段留空。
选择**下一步**。
9. 在下一页的“**查看 + 提交**”选项卡中，按“**创建**”。
10. 你将进入一个页面，其中正在创建这一新创建的 Azure OpenAI 资源。 你会看到文字“**部署正在进行**”。 请等待几秒钟，以便此资源完成部署。 部署资源后，单击“**转到资源**”按钮。
11. **结果：** 现在你将位于包含新创建的 Azure OpenAI 资源的页面中。 可以通过检查页面左上角的资源名称进行验证。 此名称应与你在上述步骤 5c 中选择的名称匹配。


## 任务 2：为 Azure OpenAI 模型实现 RAG

在此任务中，将了解如何使用数据源为自己的测试环境实现 RAG。

1. 在新创建的 Azure OpenAI 资源页中，单击页面顶部功能区中的“**转到 Azure AI Foundry 门户**”。
2. 在左侧的“操场”下，选择“聊天”。******** 现在，在“聊天操场”页下的“设置”部分中，选择“+ 创建新部署”。************
3. 在标题为“选择聊天完成模型”的弹出窗口中向下滚动，然后选择“gpt-4 >确认”选项。************
4. 在“部署模型 gtp-4”窗口中，保留默认设置的所有内容，然后选择“部署”。********
5. 在“**聊天操场**”页中，选择位于屏幕底部附近的“**添加数据** >**+ 添加数据源**”。
6. 在“**选择或添加数据源**”窗口中，选择“**选择数据源**”下拉列表，然后选择“**上传文件（预览版）**”。
7. 在下一页的“**数据源**”中，确保“**选择数据源**”下拉列表设置为“**上传文件（预览版）**”

**备注：** 对于使用自己环境的学习者，用户在填写以下步骤 a-c 的字段时，需自行决定。 对于使用提供的环境的学员，请按照下面步骤 a-b 中的说明使用默认值。 
  
   a. 在“**订阅**”字段中，确保已选择默认值。
   
   b. 在“**选择 Azure Blob 存储资源**”字段中，选择“**新建 Azure Blob 存储资源**”> 在名为“**创建存储帐户**”的新窗口的“**基本信息**”选项卡下，确保“**订阅**”和“**资源组**”字段设置为默认值 - 选择“**资源组**”的唯一可用值。 在“**实例详细信息**”下，为“**存储帐户名称**”设置名称。 将其余字段保留原样。 选择“查看 + 创建”。 在“**查看 + 创建**”选项卡下，选择“**创建**”按钮。 Azure Blob 存储资源的部署需要一段时间。
   
   c. 导航回“**聊天操场**”窗口。 选择字段“**选择 Azure Blob 存储资源**”旁的刷新按钮，然后选择在上述步骤 b 中创建的资源。 选择“**启用 CORS**”按钮。
   
8. 对于“**选择 Azure AI 搜索资源**”字段，选择“**新建 Azure AI 搜索资源**”。  确保将“**订阅**”和“**资源组**”字段设置为所选的值。

   **备注：** 对于使用自己环境的学习者，请在选择“**订阅**”和“**资源组**”字段的值时自行决定。

9. 单击“**资源组**”下拉列表中的值以选择所选的选项。 输入“**服务名称**”> 确保所有其他字段均设置为默认值 > 选择“**查看 + 创建** >**创建**”。 Azure AI 搜索资源的部署需要一段时间。
10. 导航回“**聊天操场**”窗口。 选择字段“**选择 Azure Blob 存储资源**”旁边的刷新按钮，然后选择在上述步骤 9 中创建的资源。
11. 在“**输入索引名称**”字段中输入名称 >选择“**下一步**”。 将此名称复制并粘贴到可访问的位置，因为后续任务中需要用到此名称。
12. 在“**上传文件**”部分中，选择“**浏览文件**”> 在文件资源管理器中，导航到“**文档**”> 选择所有三个文件：**ContosoAI ChipEnhance Perks Program.docx**、**ContosoAI Insurance Plans.docx** 和**Overview of ContosoAI.docx** >选择“**打开**”> 这三个文件现在应显示在窗口的“**上传文件**”页中 > 选择“**上传文件** >**下一步**”。
13. 在“**数据管理**”部分下，将所有内容保留为默认值，然后选择“**下一步**”。
14. 在“**“数据连接**”下，选择“**API 密钥** >**下一步** >**保存并关闭**”。
15. 在“**聊天操场**”窗口中，选择窗口左上角功能区中的“**查看代码**”。
16. 在“**示例代码**”窗口中，选择第一个字段右侧的下拉列表，然后选择“**json**”> 切换到“**密钥身份验证**”选项卡：
    
    a. 复制并粘贴以下值，因为后续任务中需要用到这些值：“**终结点**”、“**API 密钥**”和“**Azure 搜索资源密钥**”。 还可以将此窗口保持打开状态，以便为即将到来的任务收集这些值。

 ## 任务 3：在测试工具和 Teams 中创建和测试自定义代理

在此任务中，将创建自定义代理并测试代理。

1. 打开**Visual Studio Code**。
2. 在 Visual Studio Code 窗口右侧，选择上方功能区中的“查看”>“扩展”，然后搜索“Microsoft 365 智能体工具包”，选择“更新” >“重启扩展”，选择“创建新智能体/应用”，然后在下拉列表中选择“自定义引擎智能体”  >“基本自定义引擎智能体” >“JavaScript” >“Azure OpenAI”。**************************************** 请注意****，可能需要关闭 VS Code，并在更新工具包后重新打开。
3. 在屏幕顶部的空白框中，首先输入：

   a. 上一任务中的“**API 密钥**”>按**Enter**。

   b. 上一任务中的“**终结点**”>按**Enter**。

   c. 对于“gpt-4”中的“Azure Open AI 部署名称”类型 > 输入 >“JavaScript”。**************** 

   d. 对于“**选择项目根文件夹所在的文件夹**”，请选择“**默认文件夹**”。

   e. 对于“**输入应用程序名称**”，请键入任何名称 >**Enter** > 在弹出窗口中选择“**是，我信任作者**”。

   f. 在上面步骤 a-f 中新建的应用的新 VS Code 窗口中，导航到屏幕左侧的“M365 工具包”图标。****

   **备注：** 对 Microsoft Teams 管理中心没有管理员访问权限的用户环境，和/或使用提供的实验室环境的学员应完成步骤 g-i。
  对于具有自己环境的学习者，请改为执行步骤 j-m。

   g. 在“**帐户**”部分下，单击“**登录到 Microsoft 365**”。 将在浏览器中打开一个新窗口。 使用提供的凭据登录。

   h.如果该值不存在，请单击“添加行”。 导航回智能体的 VS Code 页。 现在，应该在**“账户”下的“**已启用自定义应用上传**”字样旁看到一个绿色复选标记。

   i. 在“**帐户**”部分下，单击“**登录到 Azure**”。 在每个弹出窗口上单击“**确定**”。 将在浏览器中打开一个新窗口。 使用提供的凭据登录。

   对于拥有 M365 租户许可证且对 Microsoft Teams 管理中心具有管理员访问权限的用户，请执行以下步骤，而不是上面的步骤 g-i：

   j. 使用管理员凭据登录https://admin.teams.microsoft.com。

   k. 转到边栏上的“ **Teams 应用**” ，然后选择“ **设置策略**”。

   l. 选择“ **全局（组织范围内的默认）**” 策略，然后打开“ **上传自定义应用程序**” 切换。

   m. 向下滚动并选择“ **保存**” 按钮保存更改。 现在，租户将允许自定义应用旁加载。 

4. 在应用的 VS Code 窗口中的提示/聊天下，导航到 src/config.js 文件。**** 删除 azureOpenAIKey:、azureOpenAIEnpoint: 和 azureOpenAIDeploymentName: 后面的所有文本。************

5. 完成上述操作后，将 : 后面已删除的文本替换为上一个任务中保存的值（注意：值必须在引号中）：****

   a. azureOpenAIKey 是上一个任务中的“API 密钥”。********

   b. azureOpenAIEndpoint 是上一个任务中的终结点。********
   
   c. “gpt-4”中的 azureOpenAIDeploymentName 类型********
   
注意****，请确保所有文本都在引号之间。
   
6. “**文件**” >“**全部保存**”
    
7. 按键盘上的 Ctrl+Shift+d，左上方会出现一个下拉列表，上面有一个绿色播放按钮和“调试”字样 > 选择下拉列表 > 选择“在 Microsoft 365 智能体操场中调试”> 按 F5。************
8. 自定义引擎智能体在所选的调试工具中运行，该工具将在浏览器中打开。 
9. 导航回应用的 VS Code 窗口。 选择“**调试**”按钮下拉列表并选择“**在 Teams (Edge) 中调试**”，然后按**F5** 或 绿色播放按钮。
10. 将在浏览器中打开一个新窗口。 系统可能会提示你登录，也可能不会。 使用提供的登录信息登录。 成功登录后，关闭窗口。
11. 应有一个窗口，其中包含新创建应用的标题。 选择“**添加**” >“**打开**”。
12. 恭喜！ 现在，可以向代理询问有关 RAG 数据文件的任何问题。
13. **备注：** 对于在自己的环境中完成此实验室的学习者，由于此代理是出于教育目的使用你自己的订阅创建的，因此用户在完成本实验室后应继续执行删除代理的操作。 若要在 Microsoft Teams 中删除自定义代理，可以：
- 选择要删除的代理，然后选择“**更多选项图标 (…)**”，然后选择“**删除**”。
- 通过选择线程中的省略号并选择“**管理应用**”，从聊天中移除代理。
- 从代理的创作体验中，选择**省略号 (...)**，然后选择“**删除**”。从代理的创作体验中，选择**省略号 (...)**，然后选择“**删除**”。

**实验室结束**

